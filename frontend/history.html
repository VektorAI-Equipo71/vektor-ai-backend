<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightOnTime - Historial de Predicciones</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <img src="/img/LogoVektorAI.svg" alt="VEKTOR AI Logo" class="logo-icon" />
                <div class="logo-text">
                    <span class="brand-name">VEKTOR AI</span>
                    <h1 class="logo-title">FlightOnTime</h1>
                </div>
            </div>
            <nav style="display: flex; gap: 1rem; align-items: center; margin-right: 1rem;">
                <a href="index.html" style="color: white; text-decoration: none; font-weight: 600;" data-i18n="nav.home">Inicio</a>
                <a href="index.html#prediccion-individual" style="color: white; text-decoration: none;" data-i18n="nav.individual">Predicci√≥n Individual</a>
                <a href="batch.html" style="color: white; text-decoration: none;" data-i18n="nav.batch">Predicci√≥n por Lote</a>
                <a href="history.html" style="color: white; text-decoration: none; font-weight: 600;" data-i18n="nav.history">Historial</a>
                <a href="stats.html" style="color: white; text-decoration: none;" data-i18n="nav.stats">Estad√≠sticas</a>
                <a href="about.html" style="color: white; text-decoration: none;" data-i18n="nav.about">Acerca de</a>
            </nav>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <!-- Selectores de Idioma (Banderas) -->
                <button id="langEsBtn" class="lang-btn active" title="Espa√±ol" data-lang="es">
                    <img src="/img/espana.png" alt="Espa√±ol" class="lang-flag-icon">
                </button>
                <button id="langEnBtn" class="lang-btn" title="English" data-lang="en">
                    <img src="/img/estados-unidos.png" alt="English" class="lang-flag-icon">
                </button>
                <!-- Bot√≥n de Configuraci√≥n -->
                <button id="settingsBtn" class="settings-btn" title="Configuraci√≥n">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="history-container">
        <h2 style="margin: 0 0 2rem 0;" data-i18n="history.title">Historial de Predicciones</h2>

        <!-- Secci√≥n de filtros -->
        <div class="filters-section">
            <h3 style="margin-bottom: 1rem;" data-i18n="history.filters.search">Filtros de B√∫squeda</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label data-i18n="history.filter.date.start">Fecha Inicio</label>
                    <input type="date" id="filterFechaInicio">
                </div>
                <div class="filter-group">
                    <label data-i18n="history.filter.date.end">Fecha Fin</label>
                    <input type="date" id="filterFechaFin">
                </div>
                <div class="filter-group">
                    <label data-i18n="history.filter.airline">Aerol√≠nea</label>
                    <select id="filterAerolinea">
                        <option value="" data-i18n="history.filter.all">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="history.filter.origin">Aeropuerto Origen</label>
                    <select id="filterOrigen">
                        <option value="" data-i18n="history.filter.all.airports">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="history.filter.destination">Aeropuerto Destino</label>
                    <select id="filterDestino">
                        <option value="" data-i18n="history.filter.all.airports">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label data-i18n="batch.prediction">Predicci√≥n</label>
                    <select id="filterPrediccion">
                        <option value="" data-i18n="history.filter.all">Todas</option>
                        <option value="0" data-i18n="history.filter.on.time">Puntual</option>
                        <option value="1" data-i18n="history.filter.delayed">Retrasado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ID de Lote</label>
                    <input type="text" id="filterBatchId" placeholder="Ej: BATCH-ABC123" style="text-transform: uppercase;">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()" data-i18n="history.search">Buscar</button>
                <button class="btn btn-secondary" onclick="clearFilters()" data-i18n="history.clear">Limpiar Filtros</button>
            </div>
        </div>

        <!-- Secci√≥n de resultados -->
        <div class="results-section">
            <div class="results-header">
                <h3 data-i18n="history.results">Resultados</h3>
                <div class="results-info" id="resultsInfo"></div>
            </div>

            <div id="statsSummary" class="stats-summary" style="display: none;"></div>

            <div id="loading" class="loading" style="display: none;">
                <p data-i18n="loading.predictions">Cargando predicciones...</p>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"/>
                </svg>
                <p data-i18n="history.no.predictions">No se encontraron predicciones con los filtros seleccionados</p>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table" id="resultsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha Predicci√≥n</th>
                            <th>Aerol√≠nea</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Fecha Partida</th>
                            <th>Distancia (km)</th>
                            <th>Predicci√≥n</th>
                            <th>Probabilidad</th>
                            <th>Confianza</th>
                            <th>ID de Lote</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button onclick="changePage(currentPage - 1)" id="prevBtn">Anterior</button>
                <span class="page-info" id="pageInfo"></span>
                <button onclick="changePage(currentPage + 1)" id="nextBtn">Siguiente</button>
            </div>
        </div>
    </main>

    <script>
        // Detectar URL base de la API
        const API_BASE_URL = (function() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const isLocalDev = hostname === 'localhost' || hostname === '127.0.0.1';
            if (isLocalDev && port !== '80' && port !== '') {
                return 'http://localhost:8080/api';
            }
            return '/api';
        })();
        
        let currentPage = 0;
        let pageSize = 20;
        let totalPages = 0;
        let currentFilters = {};

        // Funci√≥n para aplicar filtros
        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            try {
                const fechaInicio = document.getElementById('filterFechaInicio');
                const fechaFin = document.getElementById('filterFechaFin');
                const aerolinea = document.getElementById('filterAerolinea');
                const origen = document.getElementById('filterOrigen');
                const destino = document.getElementById('filterDestino');
                const prediccion = document.getElementById('filterPrediccion');
                const batchId = document.getElementById('filterBatchId');
                
                if (!fechaInicio || !fechaFin || !aerolinea || !origen || !destino || !prediccion || !batchId) {
                    console.error('‚ùå Error: No se encontraron todos los elementos de filtro');
                    alert('Error: No se pudieron encontrar los campos de filtro. Por favor recarga la p√°gina.');
                    return;
                }
                
                currentFilters = {
                    fechaInicio: fechaInicio.value || '',
                    fechaFin: fechaFin.value || '',
                    aerolinea: aerolinea.value || '',
                    origen: origen.value || '',
                    destino: destino.value || '',
                    prediccion: prediccion.value || '',
                    batchId: batchId.value.trim().toUpperCase() || ''
                };
                console.log('üìã Filtros aplicados:', currentFilters);
                currentPage = 0; // Resetear a la primera p√°gina
                loadPredictions(0);
            } catch (error) {
                console.error('‚ùå Error en applyFilters:', error);
                alert('Error al aplicar filtros: ' + error.message);
            }
        };

        // Funci√≥n para limpiar filtros
        window.clearFilters = function() {
            console.log('üßπ Limpiando filtros...');
            try {
                document.getElementById('filterFechaInicio').value = '';
                document.getElementById('filterFechaFin').value = '';
                document.getElementById('filterAerolinea').value = '';
                document.getElementById('filterOrigen').value = '';
                document.getElementById('filterDestino').value = '';
                document.getElementById('filterPrediccion').value = '';
                document.getElementById('filterBatchId').value = '';
                currentFilters = {};
                currentPage = 0;
                
                // Restaurar fechas por defecto
                setDefaultDates();
                
                // Ocultar todos los resultados y no cargar datos
                const loading = document.getElementById('loading');
                const table = document.getElementById('resultsTable');
                const emptyState = document.getElementById('emptyState');
                const pagination = document.getElementById('pagination');
                const statsSummary = document.getElementById('statsSummary');
                const resultsInfo = document.getElementById('resultsInfo');
                
                if (loading) loading.style.display = 'none';
                if (table) table.style.display = 'none';
                if (emptyState) emptyState.style.display = 'none';
                if (pagination) pagination.style.display = 'none';
                if (statsSummary) statsSummary.style.display = 'none';
                if (resultsInfo) resultsInfo.textContent = '';
                
                // Limpiar el cuerpo de la tabla
                const tbody = document.getElementById('resultsBody');
                if (tbody) tbody.innerHTML = '';
                
                console.log('‚úÖ Filtros limpiados y resultados ocultos');
            } catch (error) {
                console.error('‚ùå Error en clearFilters:', error);
                alert('Error al limpiar filtros: ' + error.message);
            }
        };

        // Funci√≥n para poblar el filtro de aerol√≠neas
        function populateAirlineFilter() {
            const select = document.getElementById('filterAerolinea');
            if (!select) {
                console.error('‚ùå No se encontr√≥ el elemento filterAerolinea');
                return;
            }
            
            console.log('üîç Poblando filtro de aerol√≠neas...');
            console.log('üîç AIRLINE_DATA disponible?', typeof window.AIRLINE_DATA !== 'undefined');
            
            // Mantener la opci√≥n "Todas"
            const todasOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (todasOption) {
                select.appendChild(todasOption);
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = window.i18n ? window.i18n.t('history.filter.all') : 'Todas';
                select.appendChild(defaultOption);
            }
            
            if (window.AIRLINE_DATA && typeof window.AIRLINE_DATA === 'object' && !Array.isArray(window.AIRLINE_DATA)) {
                const airlineCodes = Object.keys(window.AIRLINE_DATA).sort();
                console.log('üîç C√≥digos de aerol√≠neas encontrados:', airlineCodes.length);
                airlineCodes.forEach(code => {
                    const airline = window.AIRLINE_DATA[code];
                    if (airline && airline.name) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = airline.name;
                        select.appendChild(option);
                    }
                });
                console.log('‚úÖ Aerol√≠neas agregadas al filtro');
            } else {
                console.warn('‚ö†Ô∏è AIRLINE_DATA no est√° disponible o no es un objeto');
                // Intentar cargar desde la API como fallback
                loadAirlineOptionsFromAPI();
            }
        }

        // Funci√≥n para poblar los filtros de aeropuertos (origen y destino)
        function populateAirportFilters() {
            const origenSelect = document.getElementById('filterOrigen');
            const destinoSelect = document.getElementById('filterDestino');
            
            if (!origenSelect || !destinoSelect) {
                console.error('‚ùå No se encontraron los elementos de filtro de aeropuertos');
                return;
            }
            
            console.log('üîç Poblando filtros de aeropuertos...');
            console.log('üîç AIRPORT_INFO disponible?', typeof window.AIRPORT_INFO !== 'undefined');
            
            // Guardar la opci√≥n "Todos" antes de limpiar
            let todasOrigenOption = origenSelect.querySelector('option[value=""]');
            if (!todasOrigenOption) {
                todasOrigenOption = document.createElement('option');
                todasOrigenOption.value = '';
                todasOrigenOption.textContent = window.i18n ? window.i18n.t('history.filter.all.airports') : 'Todos';
            }
            
            let todasDestinoOption = destinoSelect.querySelector('option[value=""]');
            if (!todasDestinoOption) {
                todasDestinoOption = document.createElement('option');
                todasDestinoOption.value = '';
                todasDestinoOption.textContent = window.i18n ? window.i18n.t('history.filter.all.airports') : 'Todos';
            }
            
            // Limpiar y agregar opci√≥n "Todos"
            origenSelect.innerHTML = '';
            origenSelect.appendChild(todasOrigenOption);
            
            destinoSelect.innerHTML = '';
            destinoSelect.appendChild(todasDestinoOption);
            
            if (window.AIRPORT_INFO && typeof window.AIRPORT_INFO === 'object') {
                const airportCodes = Object.keys(window.AIRPORT_INFO).sort();
                console.log('üîç C√≥digos de aeropuertos encontrados:', airportCodes.length);
                airportCodes.forEach(code => {
                    const info = window.AIRPORT_INFO[code];
                    if (info && info.name) {
                        const displayText = window.formatAirportDisplay ? window.formatAirportDisplay(code) : `${code} - ${info.name}${info.city ? ` (${info.city})` : ''}`;
                        
                        // Agregar a origen
                        const optionOrigen = document.createElement('option');
                        optionOrigen.value = code;
                        optionOrigen.textContent = displayText;
                        origenSelect.appendChild(optionOrigen);
                        
                        // Agregar a destino
                        const optionDestino = document.createElement('option');
                        optionDestino.value = code;
                        optionDestino.textContent = displayText;
                        destinoSelect.appendChild(optionDestino);
                    }
                });
                console.log('‚úÖ Aeropuertos agregados a los filtros');
            } else {
                console.warn('‚ö†Ô∏è AIRPORT_INFO no est√° disponible');
                // Intentar cargar desde la API como fallback
                loadAirportOptionsFromAPI();
            }
        }

        // Funci√≥n auxiliar para cargar aerol√≠neas desde la API (fallback)
        async function loadAirlineOptionsFromAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/predictions/filters`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.aerolineas && Array.isArray(data.aerolineas)) {
                        const select = document.getElementById('filterAerolinea');
                        data.aerolineas.forEach(aerolinea => {
                            const option = document.createElement('option');
                            option.value = aerolinea;
                            option.textContent = aerolinea;
                            select.appendChild(option);
                        });
                        console.log('‚úÖ Aerol√≠neas cargadas desde la API');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error cargando aerol√≠neas desde la API:', error);
            }
        }

        // Funci√≥n auxiliar para cargar aeropuertos desde la API (fallback)
        async function loadAirportOptionsFromAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/predictions/filters`);
                if (response.ok) {
                    const data = await response.json();
                    const origenSelect = document.getElementById('filterOrigen');
                    const destinoSelect = document.getElementById('filterDestino');
                    
                    if (data.origenes && Array.isArray(data.origenes)) {
                        data.origenes.forEach(origen => {
                            const option = document.createElement('option');
                            option.value = origen;
                            option.textContent = origen;
                            origenSelect.appendChild(option);
                            destinoSelect.appendChild(option.cloneNode(true));
                        });
                        console.log('‚úÖ Aeropuertos cargados desde la API');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error cargando aeropuertos desde la API:', error);
            }
        }

        // Funci√≥n para inicializar i18n y escuchar cambios de idioma
        function initializeI18n() {
            if (window.i18n) {
                // Aplicar traducciones iniciales
                const elementsWithI18n = document.querySelectorAll('[data-i18n]');
                elementsWithI18n.forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (key && window.i18n) {
                        const translation = window.i18n.t(key);
                        if (element.tagName === 'OPTION' || element.tagName === 'OPTGROUP') {
                            element.textContent = translation;
                        } else {
                            element.textContent = translation;
                        }
                    }
                });
                
                // Escuchar cambios de idioma
                window.addEventListener('languageChanged', () => {
                    console.log('üåê Idioma cambiado, actualizando traducciones...');
                    const elementsWithI18n = document.querySelectorAll('[data-i18n]');
                    elementsWithI18n.forEach(element => {
                        const key = element.getAttribute('data-i18n');
                        if (key && window.i18n) {
                            const translation = window.i18n.t(key);
                            if (element.tagName === 'OPTION' || element.tagName === 'OPTGROUP') {
                                element.textContent = translation;
                            } else {
                                element.textContent = translation;
                            }
                        }
                    });
                    // Re-cargar predicciones para actualizar textos generados din√°micamente
                    if (typeof loadPredictions === 'function') {
                        loadPredictions(currentPage);
                    }
                });
            }
        }

        // Funci√≥n para inicializar los filtros cuando los datos est√©n disponibles
        function initializeFilters() {
            console.log('üîß Inicializando filtros...');
            console.log('üîß AIRLINE_DATA:', typeof window.AIRLINE_DATA, window.AIRLINE_DATA ? Object.keys(window.AIRLINE_DATA).length : 'no disponible');
            console.log('üîß AIRPORT_INFO:', typeof window.AIRPORT_INFO, window.AIRPORT_INFO ? Object.keys(window.AIRPORT_INFO).length : 'no disponible');
            
            // Poblar los filtros
            populateAirlineFilter();
            populateAirportFilters();
            
            // Si los datos no est√°n disponibles, intentar de nuevo despu√©s de un delay
            if (!window.AIRLINE_DATA || !window.AIRPORT_INFO) {
                console.log('‚è≥ Datos no disponibles, reintentando en 500ms...');
                setTimeout(() => {
                    console.log('üîÑ Reintentando poblar filtros...');
                    populateAirlineFilter();
                    populateAirportFilters();
                }, 500);
            }
        }

        // Funci√≥n de inicializaci√≥n principal
        function initializeHistoryPage() {
            console.log('üìÑ Inicializando history page...');
            
            // Inicializar i18n primero
            initializeI18n();
            
            // Establecer fechas por defecto primero
            setDefaultDates();
            
            // Esperar a que los scripts se carguen antes de poblar filtros
            setTimeout(() => {
                initializeFilters();
                
                // Si los datos a√∫n no est√°n disponibles, reintentar
                if (!window.AIRLINE_DATA || !window.AIRPORT_INFO) {
                    console.log('‚è≥ Datos a√∫n no disponibles, esperando m√°s tiempo...');
                    setTimeout(() => {
                        console.log('üîÑ Segundo intento de poblar filtros...');
                        initializeFilters();
                    }, 1000);
                }
            }, 500);
            
            // Cargar predicciones iniciales despu√©s de un peque√±o delay
            setTimeout(() => {
                loadPredictions();
            }, 1000);
        }

        // Cargar opciones de filtros al iniciar
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', () => {
                initializeHistoryPage();
            });
        } else {
            // DOM ya est√° listo
            initializeHistoryPage();
        }

        // Funci√≥n para establecer fechas por defecto
        function setDefaultDates() {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.getElementById('filterFechaInicio').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('filterFechaFin').value = today.toISOString().split('T')[0];
        }

        async function loadPredictions(page = 0) {
            const loading = document.getElementById('loading');
            const table = document.getElementById('resultsTable');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');
            const statsSummary = document.getElementById('statsSummary');

            loading.style.display = 'block';
            table.style.display = 'none';
            emptyState.style.display = 'none';
            pagination.style.display = 'none';
            statsSummary.style.display = 'none';

            try {
                const params = new URLSearchParams({
                    page: page.toString(),
                    size: pageSize.toString()
                });

                // Agregar filtros
                if (currentFilters.fechaInicio) {
                    params.append('fechaInicio', currentFilters.fechaInicio);
                }
                if (currentFilters.fechaFin) {
                    params.append('fechaFin', currentFilters.fechaFin);
                }
                if (currentFilters.aerolinea) {
                    params.append('aerolinea', currentFilters.aerolinea);
                }
                if (currentFilters.origen) {
                    params.append('origen', currentFilters.origen);
                }
                if (currentFilters.destino) {
                    params.append('destino', currentFilters.destino);
                }
                if (currentFilters.prediccion !== undefined && currentFilters.prediccion !== '') {
                    params.append('prediccion', parseInt(currentFilters.prediccion));
                }
                if (currentFilters.batchId && currentFilters.batchId.trim() !== '') {
                    params.append('batchId', currentFilters.batchId.trim());
                }

                const url = `${API_BASE_URL}/predictions?${params}`;
                console.log('üîç Consultando:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì• Datos recibidos:', data);

                loading.style.display = 'none';

                if (data.content && data.content.length > 0) {
                    displayResults(data);
                    currentPage = data.currentPage || 0;
                    totalPages = data.totalPages || 0;
                    updatePagination(data);
                    updateStats(data.content);
                    table.style.display = 'table';
                    pagination.style.display = 'flex';
                    statsSummary.style.display = 'grid';
                } else {
                    emptyState.style.display = 'block';
                    table.style.display = 'none';
                    pagination.style.display = 'none';
                    statsSummary.style.display = 'none';
                }

            } catch (error) {
                loading.style.display = 'none';
                table.style.display = 'none';
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                statsSummary.style.display = 'none';
                console.error('‚ùå Error cargando predicciones:', error);
                
                // Mostrar mensaje de error m√°s descriptivo
                const resultsSection = document.querySelector('.results-section');
                if (resultsSection) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;';
                    errorMsg.innerHTML = `<strong>Error:</strong> ${error.message}<br>Verifique la consola del navegador para m√°s detalles.`;
                    resultsSection.insertBefore(errorMsg, resultsSection.firstChild);
                    
                    setTimeout(() => errorMsg.remove(), 5000);
                }
            }
        }

        function displayResults(data) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            // Declarar i18n una sola vez al inicio de la funci√≥n
            const i18n = window.i18n || { t: (key) => key };
            
            data.content.forEach(pred => {
                const row = document.createElement('tr');
                const predictionClass = pred.prediccion === 1 ? 'prediction-retrasado' : 'prediction-puntual';
                const predictionText = pred.prediccion === 1 ? i18n.t('batch.delayed') : i18n.t('batch.on.time');
                
                // Mejorar formato de aerol√≠nea
                let aerolineaText = pred.aerolinea;
                if (window.AIRLINE_DATA && window.AIRLINE_DATA[pred.aerolinea]) {
                    aerolineaText = window.AIRLINE_DATA[pred.aerolinea].name || pred.aerolinea;
                }
                
                // Formatear fecha de predicci√≥n
                let fechaPred = '-';
                if (pred.fechaPrediccion) {
                    try {
                        const fecha = new Date(pred.fechaPrediccion);
                        if (!isNaN(fecha.getTime())) {
                            fechaPred = fecha.toLocaleString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        fechaPred = pred.fechaPrediccion;
                    }
                }
                
                row.innerHTML = `
                    <td>${pred.id}</td>
                    <td>${fechaPred}</td>
                    <td>${aerolineaText}</td>
                    <td>${pred.origen}</td>
                    <td>${pred.destino}</td>
                    <td>${pred.fechaPartida || '-'}</td>
                    <td>${pred.distanciaKm ? pred.distanciaKm.toFixed(2) : '-'}</td>
                    <td><span class="prediction-badge ${predictionClass}">${predictionText}</span></td>
                    <td>${pred.probabilidad ? (pred.probabilidad * 100).toFixed(2) + '%' : '-'}</td>
                    <td>${pred.confianza ? (pred.confianza * 100).toFixed(2) + '%' : '-'}</td>
                    <td>${pred.batchId || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar informaci√≥n de resultados (usando la misma variable i18n ya declarada)
            const info = document.getElementById('resultsInfo');
            const showingText = i18n.t('history.showing');
            const ofText = i18n.t('history.of');
            const predictionsText = i18n.t('history.predictions');
            info.textContent = `${showingText} ${data.content.length} ${ofText} ${data.totalElements} ${predictionsText}`;
        }

        function updatePagination(data) {
            const pageInfo = document.getElementById('pageInfo');
            const i18n = window.i18n || { t: (key) => key };
            const pageText = i18n.t('history.page');
            pageInfo.textContent = `${pageText} ${data.currentPage + 1} ${i18n.t('history.of')} ${data.totalPages}`;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            prevBtn.disabled = !data.hasPrevious;
            nextBtn.disabled = !data.hasNext;
        }

        function updateStats(predictions) {
            const total = predictions.length;
            const retrasados = predictions.filter(p => p.prediccion === 1).length;
            const puntuales = total - retrasados;
            const porcentajeRetrasados = total > 0 ? ((retrasados / total) * 100).toFixed(2) : 0;

            const statsSummary = document.getElementById('statsSummary');
            const i18n = window.i18n || { t: (key) => key };
            statsSummary.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label" data-i18n="stats.total.label">${i18n.t('stats.total.label')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #28a745;">${puntuales}</div>
                    <div class="stat-label" data-i18n="stats.on.time.label">${i18n.t('stats.on.time.label')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #dc3545;">${retrasados}</div>
                    <div class="stat-label" data-i18n="stats.delayed.label">${i18n.t('stats.delayed.label')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${porcentajeRetrasados}%</div>
                    <div class="stat-label" data-i18n="stats.percentage.label">${i18n.t('stats.percentage.label')}</div>
                </div>
            `;
        }

        function changePage(page) {
            if (page >= 0 && page < totalPages) {
                loadPredictions(page);
            }
        }

        // Las funciones applyFilters() y clearFilters() est√°n definidas globalmente arriba como window.applyFilters y window.clearFilters
    </script>

    <!-- Panel de Configuraci√≥n -->
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-panel-content">
            <div class="settings-panel-header">
                <h2 data-i18n="settings.title">Configuraci√≥n</h2>
                <button id="settingsClose" class="settings-close-btn" aria-label="Cerrar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6L18 18"/>
                    </svg>
                </button>
            </div>
            
            <div class="settings-section">
                <h3 data-i18n="settings.language">Idioma</h3>
                <div class="settings-options">
                    <button id="langEs" class="settings-option active" data-lang="es">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <img src="/img/espana.png" alt="Espa√±ol" style="width: 24px; height: 24px; border-radius: 50%; object-fit: contain;">
                            <span>Espa√±ol</span>
                        </div>
                    </button>
                    <button id="langEn" class="settings-option" data-lang="en">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <img src="/img/estados-unidos.png" alt="English" style="width: 24px; height: 24px; border-radius: 50%; object-fit: contain;">
                            <span>English</span>
                        </div>
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h3 data-i18n="settings.units">Sistema de Unidades</h3>
                <div class="settings-options">
                    <button id="unitKm" class="settings-option active" data-unit="km">
                        <div>
                            <strong>Sistema Internacional (SI)</strong>
                            <span class="settings-option-desc">Kil√≥metros (km) ‚Ä¢ Celsius (¬∞C) ‚Ä¢ m/s</span>
                        </div>
                    </button>
                    <button id="unitMiles" class="settings-option" data-unit="miles">
                        <div>
                            <strong>Imperial</strong>
                            <span class="settings-option-desc">Millas (mi) ‚Ä¢ Fahrenheit (¬∞F) ‚Ä¢ mph</span>
                        </div>
                    </button>
                </div>
            </div>

            <div class="settings-info">
                <p data-i18n="settings.save.info" style="font-size: 0.85rem; color: var(--color-gray-600); margin: 0; padding: 1rem; background: var(--color-gray-50); border-radius: 8px;">
                    üí° Las preferencias se guardan autom√°ticamente y se aplicar√°n en toda la aplicaci√≥n.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p data-i18n="footer.text">&copy; 2026 FlightOnTime | Sistema de Misi√≥n Cr√≠tica</p>
    </footer>

    <script src="i18n.js"></script>
    <script src="airline_data.js"></script>
    <!-- No cargar app.js aqu√≠ porque puede causar conflictos -->
</body>
</html>

